
---
## Meterpreter Fundamentals

We can this MSF module: **"post/windows/gather/win_privs"** which will print if UAC is enabled, and if the current account is ADMIN enabled. It will also print UID, foreground SESSION ID, is SYSTEM status and current process PRIVILEGES

Another MSF module: **"post/windows/gather/enum_logged_on_users"**  which will enumerate current and recently logged on Windows users.

Another MSF module: **"post/windows/gather/checkvm"** which will attempt to determine whether the system is running inside of a virtual environment

Another MSF module: **"post/windows/gather/enum_computers"** which will enumerate computers included in the primary Active Directory domain.

---

## Meterpreter Basics Lab

In this lab environment, you will be provided with GUI access to a Kali machine. The target machine will be accessible at **demo.ine.local**.

**Objective:** Perform the following tasks to complete the lab:

1. Check the present working directory on remote (exploited) machine.
2. List the files present in present working directory of the remote machine.
3. Check the present working directory on local (attacker) machine.
4. List the files present in present working directory of the local machine.
5. Get the flag value present in /app/flag1 file.
6. Change the flag value present in /app/flag1, so that no one else can get the right flag.
7. Change the present working directory to a suspiciously named directory in /app and read the flag from a hidden file present in that directory.
8. Get the flag5.zip to local machine, open it using password 56784. The information given in the extracted file will give clue about the location of the another flag.
9. Delete the .zip file from the directory.
10. Print checksum of file mentioned in the extracted file (Refer to Q8).
11. Check the PATH environment variable on the remote machine.
12. There is a file with string “ckdo” in its name in one of the places included in PATH variable. Print the flag hidden in that file.
13. Change to tools directory on the local machine.
14. Upload a PHP webshell to app directory of the remote machine.
---


We will start with an Nmap scan in MSF: `db_nmap -Pn -A -v demo.ine.local`

We will find two ports open: http/80, and MySql/3306

We will run dirb against the target:`dirb http://192.28.191.3/ /usr/share/dirb/wordlists/big.txt -X .php,.html` 

This will show us a file called phpinfo.php. We will use curl to fetch its content and look for a keyword called xdebug:  `curl http://192.28.191.3/phpinfo.php |grep "debug"` 

The website seems to be using xdebug which is a PHP extension that provides debugging and profiling capabilities for PHP applications. Luckily, there is an exploit module for xdebug extension in MSF.

Upon searching for xdebug in MSF, we will find this exploit module:**"unix/http/xdebug_unauth_exec"** which can be used to get a reverse shell on the target machine.

After running it, we will indeed get a meterpreter session on the target machine.

The first flag can be found in: "/app" directory in "flag1" file.

The second flag can be found in: "Secret Files" in a file called: ".flag2"

The third flag is quite tricky to get. First, we need to download flag5.zip and unzip it on our local machine. We will get a file called list, and it has a clue saying: "MD5 hash /bin/bash".

We will got to the "/bin" directory in the target machine and calculate the MD5 hash value of the bash file: `md5sum bash`

To get flag6, we will need to know what is the variable PATH on our target machine: `echo $PATH`
the value is:"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" That means will need to search starting from the "/usr" directory: `find /usr -type f -name "*ckdo*" 2>/dev/null`

The file that we will get is: "/usr/bin/backdoor" and inside it, we will get flag6

---


## Windows Privilege Escalation: Bypassing UAC With MSF

There is a MSF module that can grant us a user with full privileges using UAC Bypass: **"windows/local/bypassuac_injection"**. However, we need to provide this module with a session and we also need to make sure that UAC bypass is even possible by chcking if our logged in user is in the Administrators group or not. To do that, on the target machine: `net localgroup Administrators` . Once we see our username, we know that UAC bypassing is possible.

If we are dealing with a x64 system, we will need to change the payload to match the target system.

---


##  Establishing Persistence On Windows

Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off our access to the target machine.

We can utilize various post exploitation persistence modules to ensure that we always have access to the target system.

**To establish persistence, we need to have elevated privileges.**

One of the MSF persistence modules that we can use with Windows machines is:**"windows/local/persistence_service".** We should also set the Service name to something that can blind in with other legit Windows services. We also have to provide it with a meterpreter session.

After we run it, we will set a payload to target Windows to start a meterpreter session: `set payload windows/meterpreter/reverse_tcp`

Then, we run it again. We now have a meterpreter session on the target that we can access at anytime.

If we lost the meterpreter session for any reason, **we can access the persistence service that we created by using "multi/handler" module and set its options to the same options as we did with persistence module (Make sure that payload and port are the same )**.

---

## Enabling RDP

We can use this MSF module to add a user to Administrators group and set a password for that user for us to be able to have a GUI access to the targets machine through RDP:**"windows/manage/enable_rdp"**
**Note: For this module to work, we need a meterpreter session with Admin privileges**

**Note: The password for the user that we need to set must contain letters and numbers.**

---

## Windows Keylogging


Keylogging is the process of recording or capture the keystrokes entered on a target system.

This technique is not limited to post exploitation, there are plenty of programs and USB devices that can be used to capture and tarnsmit the keystrokes entered on a system.

Meterpreter on Windows system provides us with the ability to capture the keystrokes entered on a target system and download them back to our local system.

We will have three commands that we can use: "keyscan_start", "keyscan_dump", and "keyscan_stop".

We start our keylogging scan by : "keyscan_start", and any keystroke the target user will do on their machine will be recorded in the buffer. To show what is inside the buffer, we use "keyscan_dump", and to stop our scan we use: keyscan_stop".

---

## Clearing Windows Event Logs


The Windows OS stores and catalogs all actions/events performed on the system and stores them in the Windows Event log.

Event logs are categorized based on the type of events they store:

- **Applications logs:** Stores applications/programs events like startups, crashes etc.
- **System logs**: Stores system events like startups, reboots etc.
- **Security logs**: Stores security events like password changes, authentication failures etc.

Event logs can be accessed via the Event Viewer on Windows.

The event logs are the first stop for any forensic investigator after a compromise has been detected. It is therefore very important to clear our tracks after we are done with our assessment.

In Meterpreter, we have a command called: **"clearev"** which would clear the whole of Even log for us.

---

## Pivoting

After getting access to the first target, we will need to add the subnet where the second and the first target are operating and communicating with each other. 

For example, we have two targets: "demo1.ine.local", and "demo2.ine.local". The first target we can scan normally with nmap but the second one we can't.  After getting a meterpreter session on the first target, we will do:`ifconfig`, this will give us info about the network the target is connected to. For example, if we got this: IPv4 Address : 10.0.18.55 ,IPv4 Netmask : 255.255.240.0. That means the subnet of the internal network that both targets are connected to is: 10.0.18.0/20 .

We will add this subnet to meterpreter: `run autoroute -s 10.0.18.0/20 `. Now, we can use msf modules to scan ports open on the second target. **Note: We cant use Nmap even within MSF**

We will use this MSF module: "auxiliary/scanner/portscan/tcp".

We set RHOSTS to our second target and we run the module. 

Let us say we find port 80 open. We will need to perform port forwarding from the second target port 80 to our local machine on any port that we choose. To do so, we go back to the meterpreter session that we have on the first target and we do: `portfwd add -l 1234 -p 80 -r 10.0.23.149` 

Now, whatever is happening on the second target port 80 is happening on our local machine on port 1234. Now, we can run nmap from MSF but we need to specify the target as our localhost and the port that we specified earlier : `db_nmap -Pn -A -p1234 -v localhost`

Let us say that we discover Badblue running on the port, we will use this MSF module:"windows/http/badblue_passthru" as usual and set the RHOSTS option to the second target IP address and the Lport to a different port of the first meterpreter session. 

**The payload option also has to change from reverse_tcp to bind_tcp** 

We will get a Meterpreter session if we ran the module.

---





